<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CUHK æ ¡å·´ Vibe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* éš±è— Scrollbar ä½†ä¿æŒåŠŸèƒ½ï¼Œä»¤ä»‹é¢æ›´ä¹¾æ·¨ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- Header å€åŸŸ -->
    <div class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-md shadow-sm z-50 px-4 py-3">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-500 bg-clip-text text-transparent">
                    CUHK Bus
                </h1>
                <p id="current-time" class="text-xs text-slate-500 font-mono mt-0.5">è¼‰å…¥ä¸­...</p>
            </div>
            <button onclick="loadData()" class="p-2 bg-slate-100 rounded-full active:scale-95 transition">
                ğŸ”„
            </button>
        </div>
        
        <!-- è·¯ç·š Filter æŒ‰éˆ• (è‡ªå‹•ç”Ÿæˆ) -->
        <div id="filter-container" class="flex gap-2 overflow-x-auto no-scrollbar mt-3 pb-1 max-w-md mx-auto">
            <!-- JavaScript æœƒåœ¨é€™è£¡æ’å…¥æŒ‰éˆ• -->
        </div>
    </div>

    <!-- åˆ—è¡¨å€åŸŸ -->
    <div class="pt-32 pb-10 px-4 max-w-md mx-auto">
        <div id="bus-list" class="space-y-3">
            <div class="text-center text-gray-400 py-10 animate-pulse">æ­£åœ¨å°‹æ‰¾æ ¡å·´æ•¸æ“š...</div>
        </div>
        
        <div class="text-center text-xs text-gray-400 mt-8 mb-4">
            æ•¸æ“šä¾†è‡ª Google Sheets â€¢ åƒ…ä¾›åƒè€ƒ<br>è«‹é ç•™è·‘è·¯æ™‚é–“ ğŸƒ
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… è¨˜å¾—æ›è¿”ä½ æ¢ Linkï¼â˜…â˜…â˜…
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRZKtMDUfO6OIolDn6HIz3wQ1QwRYB1-PMu3XMEPg5l06BJib6aWyawFj_6h_iSTdBTKS-t6Di6DOv/pub?output=csv';
        
        let allBusData = [];
        let activeFilter = 'All';

        // 1. åˆå§‹åŒ–
        window.onload = function() {
            updateClock();
            setInterval(updateClock, 1000); // æ¯ç§’æ›´æ–°æ™‚é˜
            loadData();
            setInterval(loadData, 60000); // æ¯60ç§’è‡ªå‹•é‡æ–°æŠ“å–æ•¸æ“š
        };

        // 2. æ›´æ–°é ‚éƒ¨æ™‚é˜
        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').innerText = 
                now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // 3. æŠ“å–æ•¸æ“š (æ ¸å¿ƒ)
        function loadData() {
            const btn = document.querySelector('button');
            btn.classList.add('animate-spin'); // åŠ å€‹æ—‹è½‰æ•ˆæœ
            
            // Cache Busting: åŠ å€‹éš¨æ©Ÿæ•¸é˜²æ­¢ç€è¦½å™¨ç”¨èˆŠæ•¸æ“š
            const url = SHEET_URL + '&t=' + Date.now();

            Papa.parse(url, {
                download: true,
                header: true,
                complete: function(results) {
                    btn.classList.remove('animate-spin');
                    processData(results.data);
                },
                error: function() {
                    btn.classList.remove('animate-spin');
                    document.getElementById('bus-list').innerHTML = '<p class="text-center text-red-500">æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡</p>';
                }
            });
        }

        // 4. è™•ç†æ•¸æ“šé‚è¼¯
        function processData(data) {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            // éæ¿¾ä¸¦è¨ˆç®—å‰©é¤˜æ™‚é–“
            allBusData = data
                .filter(bus => bus.Time && bus.Route) // ç¢ºä¿æœ‰æ™‚é–“å’Œè·¯ç·š
                .map(bus => {
                    const [h, m] = bus.Time.split(':').map(Number);
                    const busMinutes = h * 60 + m;
                    const diff = busMinutes - currentMinutes;
                    return { ...bus, diff, busMinutes };
                })
                .filter(bus => bus.diff >= 0) // åªä¿ç•™æœªä¾†çš„è»Š (diff >= 0)
                .sort((a, b) => a.diff - b.diff); // æŒ‰æ™‚é–“æ’åºï¼Œæœ€è¿‘çš„åœ¨ä¸Šé¢

            generateFilters();
            renderList();
        }

        // 5. ç”Ÿæˆ Filter æŒ‰éˆ•
        function generateFilters() {
            const container = document.getElementById('filter-container');
            // æ‰¾å‡ºæ‰€æœ‰ç¨ç‰¹çš„è·¯ç·š
            const routes = ['All', ...new Set(allBusData.map(b => b.Route))];
            
            // å¦‚æœæŒ‰éˆ•å·²ç¶“å­˜åœ¨ä¸”æ•¸é‡æ²’è®Šï¼Œå°±ä¸é‡ç¹ªï¼Œé¿å…é–ƒçˆ
            if (container.children.length === routes.length) return;

            container.innerHTML = routes.map(route => `
                <button onclick="setFilter('${route}')" 
                    class="px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors
                    ${activeFilter === route ? 'bg-purple-600 text-white shadow-md' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}">
                    ${route}
                </button>
            `).join('');
        }

        // 6. åˆ‡æ› Filter
        window.setFilter = function(route) {
            activeFilter = route;
            generateFilters(); // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            renderList();      // æ›´æ–°åˆ—è¡¨
        }

        // 7. æ¸²æŸ“åˆ—è¡¨ (UI)
        function renderList() {
            const listDiv = document.getElementById('bus-list');
            
            const filteredData = activeFilter === 'All' 
                ? allBusData 
                : allBusData.filter(b => b.Route === activeFilter);

            if (filteredData.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center py-10 bg-white rounded-xl shadow-sm">
                        <p class="text-4xl mb-2">ğŸ˜´</p>
                        <p class="text-gray-500">æš«æ™‚æ²’æœ‰ ${activeFilter === 'All' ? '' : activeFilter + ' è™Ÿ'} è»Š</p>
                    </div>`;
                return;
            }

            listDiv.innerHTML = filteredData.map(bus => {
                // æ ¹æ“šå‰©é¤˜æ™‚é–“æ±ºå®šé¡è‰²
                let timeClass = 'text-green-600 bg-green-50';
                let urgencyText = 'åˆ†é˜';
                
                if (bus.diff <= 5) {
                    timeClass = 'text-red-600 bg-red-50 animate-pulse'; // å°‘æ–¼5åˆ†é˜é–ƒçˆ
                    urgencyText = 'è¶•å¿«!';
                } else if (bus.diff <= 10) {
                    timeClass = 'text-yellow-600 bg-yellow-50';
                }

                // å¦‚æœæ˜¯å¤§æ–¼ 60 åˆ†é˜ï¼Œé¡¯ç¤ºå°æ™‚
                let displayDiff = bus.diff;
                if (bus.diff > 60) {
                   displayDiff = Math.floor(bus.diff / 60) + 'å°æ™‚' + (bus.diff % 60);
                }

                return `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center transform transition hover:scale-[1.02]">
                    <div class="flex items-center gap-3">
                        <div class="bg-slate-800 text-white font-bold w-10 h-10 rounded-lg flex items-center justify-center text-lg">
                            ${bus.Route}
                        </div>
                        <div>
                            <div class="font-bold text-slate-700 text-lg">${bus.Time}</div>
                            <div class="text-xs text-slate-400">${bus.Note || 'æ­£å¸¸ç­æ¬¡'}</div>
                        </div>
                    </div>
                    <div class="px-3 py-1 rounded-lg font-bold text-right ${timeClass}">
                        <div class="text-xl leading-none">${displayDiff}</div>
                        <div class="text-[10px] opacity-80">${urgencyText}</div>
                    </div>
                </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
