<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CUHK æ ¡å·´ Vibe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* é˜²æ­¢ iOS é»æ“Šé«˜äº® */
        button { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen font-sans">

    <!-- Header å€åŸŸ -->
    <div class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-md shadow-sm z-50 px-4 pt-3 pb-1 border-b border-slate-100">
        <div class="max-w-md mx-auto">
            <!-- Top Row: Title & Time & Refresh -->
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h1 class="text-2xl font-black bg-gradient-to-r from-purple-700 to-blue-600 bg-clip-text text-transparent tracking-tighter">
                        CUHK Bus
                    </h1>
                    <p id="current-time" class="text-xs text-slate-400 font-mono font-medium mt-0.5">è¼‰å…¥ä¸­...</p>
                </div>
                <button onclick="loadData()" id="refresh-btn" class="p-2 bg-slate-50 text-slate-600 rounded-full active:scale-95 transition hover:bg-slate-100 border border-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>

            <!-- Mode Selector (å¹³æ—¥/å‡æ—¥åˆ‡æ›) -->
            <div id="mode-selector" class="flex gap-2 mb-3">
                <!-- Javascript æœƒå¡«å……é€™è£¡ -->
            </div>
            
            <!-- è·¯ç·š Filter æŒ‰éˆ• -->
            <div id="filter-container" class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                <!-- Javascript æœƒå¡«å……é€™è£¡ -->
            </div>
        </div>
    </div>

    <!-- åˆ—è¡¨å€åŸŸ -->
    <div class="pt-40 pb-12 px-4 max-w-md mx-auto">
        <div id="bus-list" class="space-y-3 min-h-[50vh]">
            <div class="flex flex-col items-center justify-center py-20 animate-pulse space-y-4">
                <div class="w-12 h-12 bg-slate-200 rounded-full"></div>
                <div class="h-4 w-32 bg-slate-200 rounded"></div>
            </div>
        </div>
        
        <div class="text-center text-[10px] text-gray-300 mt-10 mb-6">
            æ•¸æ“šä¾†è‡ªæ ¡å·´è³‡æ–™åº« â€¢ JSON Static Mode<br>
            è«‹é ç•™è·‘è·¯æ™‚é–“ ğŸƒ
        </div>
    </div>

    <script>
        // --- è¨­å®šèˆ‡ç‹€æ…‹ ---
        const DATA_URL = 'bus_data.json';
        let rawData = [];
        let activeRouteFilter = 'All';
        
        // è‡ªå‹•åµæ¸¬æ¨¡å¼ï¼šå¦‚æœæ˜¯æ˜ŸæœŸæ—¥(0)ï¼Œé è¨­ç‚º sundayï¼Œå¦å‰‡ weekday
        let currentMode = new Date().getDay() === 0 ? 'sunday' : 'weekday';

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderModeSelector();
            updateClock();
            setInterval(updateClock, 1000);
            loadData();
            // æ¯ 60 ç§’è‡ªå‹•é‡æ•´ä¸€æ¬¡è³‡æ–™
            setInterval(loadData, 60000); 
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        // 1. è®€å– JSON
        function loadData() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('animate-spin');

            fetch(DATA_URL + '?t=' + Date.now()) // åŠ  timestamp é˜²æ­¢ cache
                .then(response => {
                    if (!response.ok) throw new Error("HTTP " + response.status);
                    return response.json();
                })
                .then(json => {
                    rawData = json;
                    btn.classList.remove('animate-spin');
                    processData();
                })
                .catch(err => {
                    console.error(err);
                    btn.classList.remove('animate-spin');
                    document.getElementById('bus-list').innerHTML = `
                        <div class="text-center py-10">
                            <p class="text-red-500 font-bold mb-2">è®€å–å¤±æ•—</p>
                            <p class="text-xs text-slate-400">è«‹ç¢ºèª bus_data.json å­˜åœ¨ä¸”æ ¼å¼æ­£ç¢º</p>
                        </div>`;
                });
        }

        // 2. è™•ç†æ•¸æ“š (éæ¿¾ã€è¨ˆç®—æ™‚é–“)
        function processData() {
            if (!rawData || rawData.length === 0) return;

            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            let upcomingBuses = [];

            rawData.forEach(route => {
                // A. æ¨¡å¼éæ¿¾ (å¹³æ—¥ vs å‡æ—¥)
                // é€™è£¡åšç°¡å–®å­—ä¸²åŒ¹é…ï¼Œæ ¹æ“šä½ çš„ DB å…§å®¹èª¿æ•´
                const dt = route.DayType || "";
                let isMatch = false;

                if (currentMode === 'weekday') {
                    // å¹³æ—¥æ¨¡å¼ï¼šåŒ…å« MON, FRI, SAT, N, æˆ–æ²’æœ‰æ¨™è¨˜
                    if (dt.includes('MON') || dt === 'N' || dt === "") isMatch = true;
                } else {
                    // å‡æ—¥æ¨¡å¼ï¼šåŒ…å« SUN, HOLIDAY, N
                    if (dt.includes('SUN') || dt.includes('HOLIDAY') || dt === 'N') isMatch = true;
                }

                if (!isMatch) return;

                // B. æ™‚é–“è¨ˆç®—
                if (route.Times && Array.isArray(route.Times)) {
                    route.Times.forEach(timeStr => {
                        // ç°¡å–®æ ¼å¼æª¢æŸ¥ HH:MM
                        if (!timeStr.includes(':')) return;

                        const [h, m] = timeStr.split(':').map(Number);
                        const busMinutes = h * 60 + m;
                        const diff = busMinutes - currentMinutes;

                        // åªé¡¯ç¤ºæœªä¾† 120 åˆ†é˜å…§çš„è»Š
                        if (diff >= 0 && diff <= 120) {
                            upcomingBuses.push({
                                Route: route.Route,
                                RouteEn: route.RouteEn,
                                Time: timeStr.substring(0, 5),
                                Note: route.Note,
                                diff: diff
                            });
                        }
                    });
                }
            });

            // C. æ’åº (æœ€è¿‘çš„åœ¨ä¸Šé¢)
            upcomingBuses.sort((a, b) => a.diff - b.diff);

            renderFilters(upcomingBuses);
            renderList(upcomingBuses);
        }

        // 3. æ¸²æŸ“åˆ—è¡¨
        function renderList(buses) {
            const listDiv = document.getElementById('bus-list');
            
            // æ‡‰ç”¨è·¯ç·šç¯©é¸
            const filtered = activeRouteFilter === 'All' 
                ? buses 
                : buses.filter(b => b.Route === activeRouteFilter);

            // åªé¡¯ç¤ºå‰ 50 ç­ï¼Œé¿å… DOM éå¤š
            const displayBuses = filtered.slice(0, 50);

            if (displayBuses.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center py-16 px-6 bg-white rounded-3xl border border-slate-100 shadow-sm mx-2">
                        <div class="text-6xl mb-4">ğŸ’¤</div>
                        <h3 class="text-lg font-bold text-slate-700 mb-1">æš«æ™‚å†‡è»Š</h3>
                        <p class="text-slate-400 text-sm">
                            ç›®å‰æ¨¡å¼ï¼š<span class="font-medium text-slate-600">${currentMode === 'weekday' ? 'å¹³æ—¥' : 'å‡æ—¥'}</span>
                            <br>è©¦å“è½‰ Mode æˆ–è€…æ€ Allï¼Ÿ
                        </p>
                    </div>`;
                return;
            }

            listDiv.innerHTML = displayBuses.map(bus => {
                // æ¨£å¼é‚è¼¯
                let statusColor = 'text-emerald-600 bg-emerald-50';
                let statusText = 'åˆ†é˜';
                let rowBorder = 'border-slate-100';
                
                if (bus.diff <= 5) {
                    statusColor = 'text-rose-600 bg-rose-50 font-bold';
                    statusText = 'å³å°‡åˆ°é”';
                    rowBorder = 'border-rose-100';
                } else if (bus.diff <= 15) {
                    statusColor = 'text-amber-600 bg-amber-50';
                }

                let displayDiff = bus.diff;
                if (bus.diff > 60) {
                    displayDiff = Math.floor(bus.diff/60) + '<span class="text-xs font-normal">h</span>' + (bus.diff%60);
                }

                return `
                <div class="group bg-white p-3 rounded-2xl shadow-sm border ${rowBorder} flex justify-between items-center mb-2 hover:shadow-md transition-all active:scale-[0.99]">
                    <div class="flex items-center gap-3">
                        <div class="bg-slate-800 text-white font-bold font-mono w-12 h-12 rounded-xl flex items-center justify-center text-xl shadow-sm group-hover:bg-slate-700 transition-colors">
                            ${bus.Route}
                        </div>
                        <div>
                            <div class="font-bold text-slate-700 text-lg leading-none mb-1">${bus.Time}</div>
                            <div class="text-[11px] text-slate-400 font-medium leading-none truncate max-w-[120px]">${bus.Note || ''}</div>
                        </div>
                    </div>
                    <div class="px-3 py-2 rounded-xl text-right ${statusColor} min-w-[70px]">
                        <div class="text-2xl font-black leading-none tracking-tight">${displayDiff}</div>
                        <div class="text-[10px] opacity-80 font-medium mt-0.5">${statusText}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // 4. æ¸²æŸ“ Filter æŒ‰éˆ•
        function renderFilters(buses) {
            const container = document.getElementById('filter-container');
            // åªåœ¨ç¬¬ä¸€æ¬¡æˆ–è·¯ç·šæ•¸é‡è®ŠåŒ–æ™‚é‡ç¹ªï¼Œé¿å…é–ƒçˆ (é€™è£¡ç°¡åŒ–ç‚ºæ¯æ¬¡é‡ç¹ªï¼Œå› ç‚ºæ€§èƒ½é–‹éŠ·å¾ˆå°)
            
            // æå–æ‰€æœ‰æœ‰è»Šçš„è·¯ç·šï¼Œä¸¦æ’åº
            const routes = ['All', ...new Set(buses.map(b => b.Route))].sort();
            
            container.innerHTML = routes.map(route => `
                <button onclick="setFilter('${route}')" 
                    class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all border
                    ${activeRouteFilter === route 
                        ? 'bg-slate-800 text-white border-slate-800 shadow-md' 
                        : 'bg-white text-slate-500 border-slate-200 hover:border-slate-300'}">
                    ${route}
                </button>
            `).join('');
        }

        // 5. UI äº¤äº’åŠŸèƒ½
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('current-time').innerText = `${timeStr}`;
        }

        function renderModeSelector() {
            const container = document.getElementById('mode-selector');
            container.innerHTML = `
                <button onclick="changeMode('weekday')" class="flex-1 py-1.5 text-xs font-bold rounded-lg border transition-all ${currentMode === 'weekday' ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-slate-100 text-slate-400 border-transparent hover:bg-slate-200'}">
                    å¹³æ—¥/æ•™å­¸æ—¥
                </button>
                <button onclick="changeMode('sunday')" class="flex-1 py-1.5 text-xs font-bold rounded-lg border transition-all ${currentMode === 'sunday' ? 'bg-red-500 text-white border-red-500 shadow-sm' : 'bg-slate-100 text-slate-400 border-transparent hover:bg-slate-200'}">
                    å‡æ—¥/æ˜ŸæœŸæ—¥
                </button>
            `;
        }

        window.changeMode = function(mode) {
            currentMode = mode;
            renderModeSelector();
            processData(); // é‡æ–°éæ¿¾
            // è¦–è¦ºå›é¥‹
            try { navigator.vibrate(10); } catch(e){}
        }

        window.setFilter = function(route) {
            activeRouteFilter = route;
            processData();
            // è¦–è¦ºå›é¥‹
            try { navigator.vibrate(10); } catch(e){}
        }

    </script>
</body>
</html>