<script>
        const DATA_URL = 'bus_data.json';
        let db = { stops: [], arrivals: [] };
        let currentStopId = ''; // 當前選中的車站
        let currentMode = new Date().getDay() === 0 ? 'sunday' : 'weekday';

        window.onload = function() {
            renderModeSelector();
            updateClock();
            setInterval(updateClock, 1000);
            loadData();
        };

        function loadData() {
            fetch(DATA_URL + '?t=' + Date.now())
                .then(res => res.json())
                .then(data => {
                    db = data;
                    // 預設選中第一個站（通常是大學站）
                    if (db.stops.length > 0) {
                        currentStopId = db.stops[0].id;
                    }
                    renderStopSelector();
                    processAndRender();
                });
        }

        // 渲染車站選擇器 (橫向滾動)
        function renderStopSelector() {
            const container = document.getElementById('filter-container');
            container.innerHTML = db.stops.map(stop => `
                <button onclick="setStop('${stop.id}')" 
                    class="px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap transition-all border
                    ${currentStopId === stop.id ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200'}">
                    ${stop.name_zh}
                </button>
            `).join('');
        }

        window.setStop = function(id) {
            currentStopId = id;
            renderStopSelector();
            processAndRender();
        };

        function processAndRender() {
            const listDiv = document.getElementById('bus-list');
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            // 1. 過濾出該站、該模式、未來的車
            const filtered = db.arrivals.filter(arr => {
                if (arr.stop_id !== currentStopId) return false;

                // 模式判斷
                const dt = arr.day_type || "";
                let isModeMatch = false;
                if (currentMode === 'weekday') {
                    if (dt.includes('MON') || dt === 'N') isModeMatch = true;
                } else {
                    if (dt.includes('SUN') || dt.includes('HOLIDAY') || dt === 'N') isModeMatch = true;
                }
                if (!isModeMatch) return false;

                // 時間計算
                const [h, m] = arr.arrival_time.split(':').map(Number);
                arr.diff = (h * 60 + m) - currentMinutes;
                arr.displayTime = arr.arrival_time.substring(0, 5);

                return arr.diff >= -2 && arr.diff <= 180; // 顯示未來3小時，及剛走2分鐘內的車
            });

            // 2. 排序
            filtered.sort((a, b) => a.diff - b.diff);

            // 3. 渲染
            if (filtered.length === 0) {
                listDiv.innerHTML = `<div class="text-center py-20 text-slate-400">該時段暫無班次經過此站</div>`;
                return;
            }

            listDiv.innerHTML = filtered.map(bus => {
                let statusColor = 'text-emerald-600 bg-emerald-50';
                if (bus.diff <= 5) statusColor = 'text-rose-600 bg-rose-50 animate-pulse font-bold';
                
                return `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center mb-2">
                    <div class="flex items-center gap-4">
                        <div class="bg-slate-800 text-white font-bold w-12 h-12 rounded-xl flex items-center justify-center text-xl">
                            ${bus.route_name}
                        </div>
                        <div>
                            <div class="font-bold text-slate-700 text-lg">${bus.displayTime}</div>
                            <div class="text-[10px] text-slate-400">${bus.note || '正常班次'}</div>
                        </div>
                    </div>
                    <div class="px-3 py-1 rounded-lg text-right ${statusColor}">
                        <div class="text-2xl font-black">${bus.diff <= 0 ? '已抵達' : bus.diff}</div>
                        <div class="text-[10px] opacity-80">${bus.diff <= 0 ? 'Arrived' : '分鐘'}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- 其餘模式切換代碼 (保持之前提供的內容) ---
        function renderModeSelector() {
            const container = document.getElementById('mode-selector');
            container.innerHTML = `
                <button onclick="changeMode('weekday')" class="flex-1 py-2 text-xs font-bold rounded-lg border ${currentMode === 'weekday' ? 'bg-blue-600 text-white border-blue-600' : 'bg-slate-100 text-slate-400'}">平日/教學日</button>
                <button onclick="changeMode('sunday')" class="flex-1 py-2 text-xs font-bold rounded-lg border ${currentMode === 'sunday' ? 'bg-red-500 text-white border-red-500' : 'bg-slate-100 text-slate-400'}">假日/星期日</button>
            `;
        }
        window.changeMode = function(m) { currentMode = m; renderModeSelector(); processAndRender(); };
        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').innerText = now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
    </script>