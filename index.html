<!DOCTYPE html>
<html lang="zh-HK" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BusVibe Pro | Enterprise Transit Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'Inter', 'system-ui'], mono: ['JetBrains Mono'] },
                    boxShadow: {
                        'apple': '0 8px 30px rgb(0,0,0,0.04)',
                        'apple-dark': '0 8px 30px rgb(0,0,0,0.2)'
                    },
                    colors: {
                        apple: { gray: '#F5F5F7', dark: '#1D1D1F', accent: '#007AFF' }
                    }
                }
            }
        }
        
        // [Fix FOUC] Load settings before render
        const SETTINGS_KEY = 'cuhk_bus_vibe_settings';
        let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {
            stopId: '', lang: 'zh', isDark: window.matchMedia('(prefers-color-scheme: dark)').matches, mode: (new Date().getDay() === 0) ? 'sunday' : 'weekday'
        };
        let { stopId: currentStopId, lang, isDark, mode: currentMode } = settings;
        
        // Apply Dark Mode immediately
        if (isDark) document.documentElement.classList.add('dark');
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-feature-settings: "cv02", "cv03", "cv04", "cv11"; }
        #modal-route-icon { font-size: clamp(1.2rem, 5vw, 1.5rem); }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); }
        .dark .glass { background: rgba(29, 29, 31, 0.75); }
        .apple-card { @apply bg-white/70 dark:bg-apple-dark/60 border border-white/20 dark:border-white/5 shadow-apple transition-all duration-300 ease-in-out; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        
        .sticky-panel { position: sticky; top: 80px; z-index: 40; }
        @media (max-width: 767px) {
            .sticky-panel { margin: 0; padding: 1rem 0; border-bottom: none; background: transparent; }
        }

        .bus-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.5rem; }
        @media (max-width: 640px) { .bus-card-grid { grid-template-columns: 1fr; gap: 1rem; } }
        /* [Fix E] iOS Safe Area Support - Increased padding for bottom sheet */
        .pb-safe-area { padding-bottom: calc(2.5rem + env(safe-area-inset-bottom)); }
        
        /* [Apple Hierarchy] Navbar 必須最高 */
        nav.sticky { z-index: 100; }

        /* [Route Modal] 修正：基礎狀態需包含過渡屬性 */
        #route-modal {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s;
        }
        #route-modal.visible {
            opacity: 1;
            visibility: visible;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
        }

        /* [Fix] 防止背景滾動 */
        body.modal-open { overflow: hidden; }

        /* [Drawer Styles] */
        #route-modal-card {
            /* 這裡的動畫時間與曲線必須與 Stop List 一致 (0.5s) */
            transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
            will-change: transform;
        }
        
        @media (max-width: 767px) {
            #route-modal-card {
                position: fixed;
                bottom: 0; left: 0; right: 0;
                width: 100%;
                /* 確保不會撞到 16 (64px) 的 Navbar，保留一些間距 */
                height: calc(100dvh - 80px);
                max-height: calc(100dvh - 80px);
                /* 更圓潤的 Apple Style 圓角 */
                border-radius: 24px 24px 0 0;
                transform: translateY(110%);
                padding-bottom: env(safe-area-inset-bottom);
                background: #F2F2F7;
            }
            .dark #route-modal-card { background: #1C1C1E; }
            #route-modal.visible #route-modal-card { transform: translateY(0); }
            .dragging { transition: none !important; }
        }

        @media (min-width: 768px) {
            /* 桌面版改為垂直置中靠右的懸浮卡片 */
            #route-modal { justify-content: flex-end; align-items: center; padding: 2rem; top: 0; }
            #route-modal-card {
                height: auto;
                max-height: calc(100vh - 4rem);
                width: 400px;
                border-radius: 32px;
                transform: translateX(120%); /* 初始隱藏在右側 */
                box-shadow: -20px 0 80px rgba(0,0,0,0.15);
            }
            #route-modal.visible #route-modal-card { transform: translateX(0); }
        }

        /* 1. 確保 pill 高度自適應並優化排版 */
        .info-pill {
            @apply bg-black/[0.03] dark:bg-white/[0.05] border border-black/[0.05] dark:border-white/[0.05] rounded-2xl p-4 flex flex-col gap-1;
            height: auto;
            min-height: min-content;
        }
        
        /* 2. 增加 Modal 內容間距，使其更 user-friendly */
        #route-modal-card .overflow-y-auto {
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 12px; /* Apple Style 典型的元素間距 */
        }

        /* 3. 強化 Grabber 視覺 */
        .apple-grabber {
            width: 36px;
            height: 5px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .dark .apple-grabber { background: rgba(255,255,255,0.15); }

        /* Apple Style Single Spin */
        @keyframes apple-rotation {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-apple-spin {
            animation: apple-rotation 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-apple-gray dark:bg-[#000000] text-slate-900 dark:text-slate-100 min-h-screen font-sans antialiased tracking-tight">

    <!-- Navbar: Apple Style Glass Floating Bar -->
    <nav class="sticky top-0 z-[100] glass border-b border-black/[0.05] dark:border-white/[0.05] h-16">
        <!-- Stage 3: Refresh Progress Bar -->
        <div class="absolute bottom-0 left-0 h-[2px] bg-apple-accent transition-all duration-[1000ms] ease-linear" id="refresh-bar" style="width: 0%"></div>
        <div class="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-black dark:bg-white rounded-[10px] flex items-center justify-center text-white dark:text-black font-[900] text-lg tracking-tighter shadow-apple">CU</div>
                <div class="flex flex-col">
                    <span class="text-[16px] font-extrabold tracking-tight leading-tight">BUS</span>
                    <span id="current-time" class="text-[10px] font-bold text-slate-400 leading-none mt-0.5 font-mono">00:00:00</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleDarkMode()" class="w-9 h-9 flex items-center justify-center hover:bg-black/[0.05] dark:hover:bg-white/[0.1] rounded-full transition-all active:scale-90">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="h-[18px] w-[18px] text-slate-700 dark:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"></svg>
                </button>
                
                <button onclick="toggleLang()" id="lang-btn-wrapper" class="flex items-center gap-1.5 px-3 h-9 bg-black/[0.05] dark:bg-white/[0.1] rounded-full hover:bg-black/[0.1] dark:hover:bg-white/[0.15] transition-all active:scale-95 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500 group-hover:text-apple-accent transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                    <span id="lang-btn" class="text-[12px] font-bold tracking-tight">EN</span>
                </button>

                <button onclick="loadData()" id="refresh-btn" class="w-9 h-9 bg-black dark:bg-white text-white dark:text-black rounded-full transition-all active:scale-90 shadow-sm flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-[18px] w-[18px]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-3 md:py-6">
        <div class="flex flex-col md:flex-row gap-4 lg:gap-6">
            
            <!-- Sidebar: Clean Apple Layout -->
            <aside class="w-full md:w-80 shrink-0">
                <div class="sticky-panel space-y-6">
                    <!-- Segmented Control (iOS Style) -->
                    <div id="mode-selector" class="flex p-1 bg-black/[0.05] dark:bg-white/[0.1] rounded-[12px] backdrop-blur-md"></div>

                    <!-- Stop Selector Card -->
                    <div class="apple-card rounded-[24px] overflow-hidden">
                        <button onclick="toggleStopList()" class="w-full py-4 px-5 flex items-center justify-between md:hidden transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full bg-apple-accent shadow-[0_0_8px_rgba(0,122,255,0.5)]"></div>
                                <span id="mobile-current-stop" class="font-semibold text-sm text-slate-900 dark:text-white">Select Stop</span>
                            </div>
                            <svg id="stop-chevron" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" /></svg>
                        </button>

                        <!-- [Fix E] iOS Style Sheet Modal -->
                        <div id="stop-list-container" class="fixed inset-0 z-[100] hidden md:static md:block md:z-auto group" aria-hidden="true">
                            <!-- Backdrop (Dimming Layer) -->
                            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm md:hidden transition-opacity opacity-0 group-[.visible]:opacity-100" onclick="toggleStopList()"></div>
                            
                            <!-- Modal Content (Slide-up Sheet) -->
                            <div id="stop-list-sheet" class="absolute bottom-0 inset-x-0 h-[85vh] bg-[#F2F2F7] dark:bg-[#1c1c1e] rounded-t-[20px] shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transform translate-y-full transition-transform duration-300 ease-[cubic-bezier(0.32,0.72,0,1)] group-[.visible]:translate-y-0 flex flex-col md:relative md:inset-auto md:h-auto md:bg-transparent md:dark:bg-transparent md:rounded-none md:shadow-none md:transform-none md:translate-y-0">
                                
                                <!-- Drag Handle (Mobile Only) -->
                                <div id="stop-list-handle" class="w-full h-8 flex items-center justify-center md:hidden shrink-0 cursor-grab active:cursor-grabbing">
                                    <div class="apple-grabber"></div>
                                </div>

                                <!-- Header Area -->
                                <div class="px-4 pb-3 border-b border-black/[0.05] dark:border-white/[0.05] flex gap-2 shrink-0 md:pt-4 md:px-4">
                                    <input type="text" id="stop-search" oninput="renderStopGrid()" placeholder="Search..." class="flex-1 h-10 bg-white dark:bg-[#2C2C2E] text-[15px] px-4 rounded-[10px] outline-none placeholder-gray-400 dark:placeholder-gray-500 shadow-sm md:bg-black/[0.03] md:dark:bg-white/[0.05] md:h-auto md:text-[13px] md:py-2 md:rounded-[12px] md:shadow-none focus:ring-2 ring-apple-accent/50 transition-all">
                                    
                                    <button id="gps-btn" onclick="findNearestStop()" class="w-10 h-10 shrink-0 bg-apple-accent text-white rounded-[10px] hover:bg-apple-accent/90 active:scale-95 transition-all shadow-sm flex items-center justify-center disabled:opacity-50 md:w-auto md:h-auto md:p-2 md:rounded-[12px]" title="Find nearest stop">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Scrollable List Area -->
                                <div id="stop-grid" class="flex-1 overflow-y-auto overscroll-contain p-3 space-y-1.5 md:max-h-[60vh] md:p-2 md:space-y-1 custom-scrollbar pb-safe-area">
                                    <!-- List items injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <section class="flex-1 space-y-3">
                <div class="flex items-center justify-between px-1">
                    <div class="flex items-center gap-2">
                        <h2 id="arrival-title" class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">Arrivals</h2>
                        <span id="selected-stop-name" class="hidden md:inline-block text-[10px] font-semibold text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded border border-indigo-100 dark:border-indigo-800">---</span>
                    </div>
                </div>
                <div id="bus-list" class="bus-card-grid"></div>
            </section>
        </div>
    </main>

    <!-- [Feature] Route Detail Modal (Apple Style) -->
    <!-- z-index: 90 確保在 Navbar(100) 下方，但在內容上方 -->
    <div id="route-modal" class="fixed inset-0 z-[90] hidden items-center justify-center">
        <!-- Backdrop: 背景使用更淡的遮罩，強調模糊而非變暗 -->
        <div class="absolute inset-0 bg-white/10 dark:bg-black/20 transition-opacity" onclick="closeRouteModal()"></div>
        
        <!-- Modal Card -->
        <div id="route-modal-card" class="relative bg-[#F2F2F7]/95 dark:bg-[#1C1C1E]/95 backdrop-blur-2xl shadow-2xl overflow-hidden flex flex-col border border-white/20 dark:border-white/5">
            
            <!-- Drag Handle (Mobile) / Top Bar -->
            <div class="h-10 w-full flex items-center justify-center md:hidden shrink-0" onclick="closeRouteModal()">
                <div class="w-10 h-1.5 bg-black/10 dark:bg-white/10 rounded-full"></div>
            </div>

            <!-- Header Section -->
            <div class="px-8 pt-6 pb-5 shrink-0">
                <div class="flex items-start justify-between">
                    <div class="flex gap-5 items-center">
                        <div id="modal-route-icon" class="w-16 h-16 bg-black dark:bg-white rounded-2xl flex items-center justify-center text-white dark:text-black font-black text-2xl shadow-xl"></div>
                        <div>
                            <h3 id="modal-route-name" class="text-2xl font-extrabold tracking-tight text-slate-900 dark:text-white"></h3>
                            <div class="flex gap-2 mt-1">
                                <span id="modal-route-category" class="text-[10px] font-bold px-2 py-0.5 bg-apple-accent text-white rounded-md tracking-wider uppercase"></span>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeRouteModal()" class="hidden md:flex w-10 h-10 bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/20 rounded-full items-center justify-center transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>

            <!-- Scrollable Body -->
            <div class="flex-1 overflow-y-auto custom-scrollbar px-8 pb-10 space-y-3">
                <div class="info-pill">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Service Hours</span>
                    <span id="modal-route-time" class="text-base font-semibold text-slate-900 dark:text-white"></span>
                </div>

                <div class="info-pill">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Schedule Info</span>
                    <span id="modal-route-freq" class="text-base font-semibold text-slate-900 dark:text-white leading-snug"></span>
                </div>

                <div class="info-pill">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Operating Days</span>
                    <span id="modal-route-days" class="text-sm font-medium text-slate-600 dark:text-slate-300"></span>
                </div>

                <div id="modal-remarks-container" class="p-4 rounded-2xl bg-amber-50 dark:bg-amber-900/10 border border-amber-200/50 dark:border-amber-700/30 hidden">
                    <p id="modal-remarks" class="text-xs text-amber-700 dark:text-amber-400 leading-relaxed font-medium italic"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DATA_URL = 'bus_data.json';
        // SETTINGS_KEY and variables are now defined in HEAD (Global scope)
        // [Feature] Added routes array
        let db = { stops: [], arrivals: [], route_times: [], routes: [] };

        const urlParams = new URLSearchParams(window.location.search);
        let mockTime = urlParams.get('time');

        let isStopListOpen = false, expandedTripId = null;
        let isFirstLoad = true;
        let fetchController = null;
        let lastCheckedDay = new Date().getDay(); // [Fix] Midnight auto-refresh
        let userPos = null; // [Stage 2] Store GPS
        let refreshTimer = 0; // [Stage 3] Countdown
        const REFRESH_INTERVAL = 30;

        // [Fix C] Haversine Formula for accurate distance
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }

        // [Fix A] Midnight-safe time difference calculator
        function calcDiffMinutes(arrivalStr, currentTotalMinutes) {
            const p = arrivalStr.split(':').map(Number);
            const arrivalTotalMin = p[0] * 60 + p[1];
            let diff = arrivalTotalMin - currentTotalMinutes;
            
            // Handle midnight crossover (e.g., Now 23:55, Bus 00:05 -> diff is -1430)
            if (diff < -720) diff += 1440; // Assume next day
            else if (diff > 720) diff -= 1440; // Assume previous day (rare)
            
            return diff;
        }

        const i18n = {
            zh: { weekday: '平日/教學日', sunday: '假日/週日', arrival: '實時到站', empty: '當前時段無班次', arrived: '已抵達', soon: '即將', unit: '分', search: '搜尋車站...', next: '後續車站 (預計)', term: '終點站' },
            en: { weekday: 'Weekday', sunday: 'Weekend/Holiday', arrival: 'Real-time Arrivals', empty: 'No service at this time', arrived: 'Arrived', soon: 'Soon', unit: 'min', search: 'Search stops...', next: 'Trip Timeline', term: 'Terminus' }
        };

        window.onload = () => {
            // [Fix FOUC] Removed redundant class toggle, handled in head
            updateThemeIcon();
            document.getElementById('lang-btn').innerText = (lang === 'zh') ? 'EN' : '中文';
            updateClock();
            setInterval(updateClock, 1000);
            setInterval(updateRefreshUI, 1000); // Stage 3 Ticker
            loadData();
            
            // Client-side ticker to update relative times (e.g. "2 min" -> "1 min") without fetching
            setInterval(() => {
                if (db.stops.length > 0) processAndRender();
            }, 5000);
            
            // [Feature] Bottom Sheet Controller
            initBottomSheet('stop-list-sheet', 'stop-list-handle', () => toggleStopList(false));
            // 對於 Route Modal，頂部區域作為 Handle
            initBottomSheet('route-modal-card', 'route-modal-card', () => closeRouteModal());

            // [Fix Resize Lock] Handle window resize to unlock scroll
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768 && isStopListOpen) {
                    toggleStopList(); // Close mobile menu if switching to desktop
                }
            });
        };

        function getNow() {
            if (!mockTime) return new Date();
            const [h, m] = mockTime.split(':');
            const d = new Date(); d.setHours(parseInt(h), parseInt(m), 0); return d;
        }

        function saveSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify({ stopId: currentStopId, lang, isDark, mode: currentMode }));
        }

        function toggleDarkMode() { isDark = !isDark; document.documentElement.classList.toggle('dark', isDark); updateThemeIcon(); saveSettings(); }
        function updateThemeIcon() {
            // SF Symbols Style Sun & Moon
            document.getElementById('theme-icon').innerHTML = isDark
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />';
        }

        function toggleLang() { lang = (lang === 'zh') ? 'en' : 'zh'; document.getElementById('lang-btn').innerText = (lang === 'zh') ? 'EN' : '中文'; document.getElementById('stop-search').placeholder = i18n[lang].search; renderAll(); saveSettings(); }

        function updateRefreshUI() {
            refreshTimer++;
            const percent = (refreshTimer / REFRESH_INTERVAL) * 100;
            document.getElementById('refresh-bar').style.width = `${percent}%`;
            if (refreshTimer >= REFRESH_INTERVAL) {
                loadData(true);
            }
        }

        async function loadData(isAutoRefresh = false) {
            refreshTimer = 0; // Reset timer on any load
            document.getElementById('refresh-bar').style.width = `0%`;
            
            if (fetchController) fetchController.abort();
            fetchController = new AbortController();
            const signal = fetchController.signal;

            const btn = document.getElementById('refresh-btn');
            if (!isAutoRefresh) {
                // 強制重啟動畫：先移除 class，觸發 reflow，再重新加入
                btn.classList.remove('animate-apple-spin');
                void btn.offsetWidth; // Trigger reflow
                btn.classList.add('animate-apple-spin');
                // 動畫結束後自動移除，以便下次點擊
                setTimeout(() => btn.classList.remove('animate-apple-spin'), 800);
            }
            
            // Skeleton only on very first empty load
            if (db.stops.length === 0) document.getElementById('bus-list').innerHTML = Array(4).fill(0).map(() => `<div class="h-14 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800 animate-pulse"></div>`).join('');
            
            try {
                const busPromise = fetch(DATA_URL + '?t=' + Date.now(), { signal }).then(r => r.json());
                const routePromise = (db.routes.length === 0) ? fetch('route.json', { signal }).then(r => r.json()) : Promise.resolve(null);
                
                const [busData, routeData] = await Promise.all([busPromise, routePromise]);
                
                db.stops = busData.stops;
                db.arrivals = busData.arrivals;
                db.route_times = busData.route_times;
                if (routeData) db.routes = routeData;

                // 動畫現在由 setTimeout 統一管理，不在此手動移除
                if (!isFirstLoad && !isAutoRefresh && navigator.vibrate) navigator.vibrate(10);
                
                if (!db.stops.some(s => s.id === currentStopId) && db.stops.length > 0) currentStopId = db.stops[0].id;
                
                if (isFirstLoad) {
                    isFirstLoad = false;
                    const hasUserPreference = localStorage.getItem(SETTINGS_KEY) && JSON.parse(localStorage.getItem(SETTINGS_KEY)).stopId;
                    if (!hasUserPreference && navigator.permissions) {
                        navigator.permissions.query({ name: 'geolocation' }).then(result => {
                            if (result.state === 'granted') findNearestStop(true);
                        });
                    }
                    renderAll(true); // First load needs full render
                } else {
                    renderAll(false); // Subsequent loads don't rebuild stop grid (prevents scroll jump)
                }
            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error(e);
                }
            }
        }

        // [Fix] fullRebuild defaults to true to maintain old behavior for manual interactions
        function renderAll(fullRebuild = true) {
            renderModeSelector();
            // Only rebuild the stop grid DOM if requested (avoids resetting scroll/input focus)
            if (fullRebuild) renderStopGrid();
            processAndRender();
            updateStopLabels();
        }

        function updateStopLabels() {
            const stop = db.stops.find(s => s.id === currentStopId);
            const name = stop ? (lang === 'zh' ? stop.name_zh : stop.name_en) : '---';
            document.getElementById('mobile-current-stop').innerText = name;
            document.getElementById('selected-stop-name').innerText = name;
            document.getElementById('arrival-title').innerText = i18n[lang].arrival;
        }

        function renderModeSelector() {
            const modes = ['weekday', 'sunday'];
            document.getElementById('mode-selector').innerHTML = modes.map(m => `
                <button onclick="changeMode('${m}')" class="flex-1 py-1.5 text-[12px] font-semibold rounded-[9px] transition-all duration-300 ${currentMode === m ? 'bg-white dark:bg-[#3A3A3C] text-black dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-900 dark:hover:text-slate-300'}">
                    ${i18n[lang][m]}
                </button>
            `).join('');
        }

        function renderStopGrid() {
            const query = document.getElementById('stop-search').value.toLowerCase();
            const container = document.getElementById('stop-grid');
            const now = getNow();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            // Stage 4: Map routes to stops for better search
            const stopRoutesMap = {};
            db.arrivals.forEach(arr => {
                if (!stopRoutesMap[arr.stop_id]) stopRoutesMap[arr.stop_id] = new Set();
                stopRoutesMap[arr.stop_id].add(arr.route_name.toLowerCase());
            });

            const busCounts = {};
            db.arrivals.forEach(arr => {
                const dt = arr.day_type || "";
                const isMatch = (currentMode === 'weekday') ? (dt.includes('MON') || dt === 'N' || dt === "") : (dt.includes('SUN') || dt.includes('HOLIDAY') || dt === 'N');
                if (!isMatch) return;

                // [Fix A] Use helper
                const diff = calcDiffMinutes(arr.arrival_time, currentMinutes);

                if (diff >= -1 && diff <= 60) {
                    busCounts[arr.stop_id] = (busCounts[arr.stop_id] || 0) + 1;
                }
            });

            // Stage 2 & 4: Enhanced Filter & Sort
            let filteredStops = db.stops.filter(s => {
                const nameMatch = s.name_zh.toLowerCase().includes(query) || s.name_en.toLowerCase().includes(query);
                const routeMatch = stopRoutesMap[s.id] && Array.from(stopRoutesMap[s.id]).some(r => r.includes(query));
                return nameMatch || routeMatch;
            });

            // Stage 2: Distance Calculation & Sorting
            filteredStops = filteredStops.map(s => {
                let dist = null;
                if (userPos && s.lat && (s.long || s.lng)) {
                    dist = getDistanceFromLatLonInKm(userPos.lat, userPos.lng, s.lat, s.long || s.lng);
                }
                return { ...s, distance: dist };
            });

            // [Enhanced Sorting] 優先排有車的站，其次按距離排
            filteredStops.sort((a, b) => {
                const countA = busCounts[a.id] || 0;
                const countB = busCounts[b.id] || 0;
                
                // 1. 是否有車 (Boolean 權重)
                const hasBusA = countA > 0 ? 1 : 0;
                const hasBusB = countB > 0 ? 1 : 0;
                
                if (hasBusA !== hasBusB) {
                    return hasBusB - hasBusA; // 有車的 (1) 排在沒車的 (0) 前面
                }
                
                // 2. 距離排序 (如果有車/沒車狀態相同)
                const distA = a.distance !== null ? a.distance : 9999;
                const distB = b.distance !== null ? b.distance : 9999;
                
                return distA - distB;
            });
            
            if (filteredStops.length === 0 && query !== "") {
                container.innerHTML = `<div class="py-8 text-center text-slate-400 text-xs">${lang === 'zh' ? '找不到相關車站' : 'No stops found'}</div>`;
                return;
            }

            container.innerHTML = filteredStops.map(stop => {
                const count = busCounts[stop.id] || 0;
                const isSelected = currentStopId === stop.id;
                
                // Apple Style Badge 樣式
                let badgeClass = count > 0
                    ? (isSelected ? 'bg-white/30 text-white' : 'bg-apple-accent/10 text-apple-accent dark:bg-apple-accent/20')
                    : 'opacity-20 grayscale';

                // 使用 Apple SF Style 的距離顯示：更小、更淡、具備單位自動轉換
                const distLabel = stop.distance
                    ? `<span class="text-[10px] font-semibold opacity-50 tracking-tight">${stop.distance < 1 ? Math.round(stop.distance * 1000) + ' m' : stop.distance.toFixed(1) + ' km'}</span>`
                    : '';

                const hasBuses = count > 0;
                return `
                <button onclick="setStop('${stop.id}', true)" class="w-full px-5 py-3 rounded-[16px] text-[15px] font-semibold text-left transition-all flex items-center justify-between group ${isSelected ? 'bg-apple-accent text-white shadow-lg scale-[1.02]' : (hasBuses ? 'text-slate-900 dark:text-white' : 'text-slate-400 dark:text-slate-600')} hover:bg-black/[0.04] dark:hover:bg-white/[0.06] mb-1">
                    <div class="flex flex-col truncate pr-2">
                        <span class="truncate leading-tight">${lang === 'zh' ? stop.name_zh : stop.name_en}</span>
                        <div class="mt-0.5">${distLabel}</div>
                    </div>
                    <span class="shrink-0 font-mono text-[10px] px-2 py-0.5 rounded-full transition-colors ${badgeClass}">
                        ${count}
                    </span>
                </button>
                `;
            }).join('');
        }

        window.toggleStopList = (forceState) => {
            isStopListOpen = (typeof forceState === 'boolean') ? forceState : !isStopListOpen;
            const container = document.getElementById('stop-list-container');
            const chevron = document.getElementById('stop-chevron');
            
            if (isStopListOpen) {
                // Open: Remove hidden first, then add visible class after a tick to trigger transition
                container.classList.remove('hidden');
                requestAnimationFrame(() => container.classList.add('visible'));
                document.body.classList.add('modal-open'); // Better scroll lock
            } else {
                container.classList.remove('visible');
                document.body.classList.remove('modal-open');
                setTimeout(() => {
                    if (!isStopListOpen) container.classList.add('hidden');
                }, 300); // Match CSS duration
            }
            if (chevron) chevron.classList.toggle('rotate-180', isStopListOpen);
        };

        // [Fix] Added 'fromUserAction' param. If false (auto-gps), don't toggle menu
        window.setStop = (id, fromUserAction = true) => {
            if (currentStopId === id && !isFirstLoad) {
                // 如果車站沒變，只需確保關閉選單，不需重新渲染全頁
                if (window.innerWidth < 768 && fromUserAction) toggleStopList(false);
                return;
            }
            
            currentStopId = id;
            if (window.innerWidth < 768 && fromUserAction) toggleStopList(false);
            
            expandedTripId = null;
            renderAll();
            saveSettings();
        };

        // [Feature] Dual-stage Positioning: Fast then Accurate
        window.findNearestStop = (silent = false) => {
            if (db.stops.length === 0) return;
            if (!navigator.geolocation) {
                if (!silent) alert(lang === 'zh' ? "不支援定位" : "No GPS support");
                return;
            }

            const btn = document.getElementById('gps-btn');
            btn.classList.add('animate-spin');
            btn.disabled = true;

            let isFinal = false; // 標記是否已獲得高精度結果

            const handleCoords = (position, isHighRes) => {
                if (isFinal && !isHighRes) return; // 如果已有高精度，忽略隨後回傳的低精度
                if (isHighRes) isFinal = true;

                const { latitude, longitude } = position.coords;
                userPos = { lat: latitude, lng: longitude };
                
                let minDistance = Infinity;
                let nearestId = null;

                db.stops.forEach(stop => {
                    const stopLong = stop.long || stop.lng;
                    if (stop.lat && stopLong) {
                        const d = getDistanceFromLatLonInKm(latitude, longitude, stop.lat, stopLong);
                        if (d < minDistance) {
                            minDistance = d;
                            nearestId = stop.id;
                        }
                    }
                });

                if (nearestId) {
                    // 如果找到的是新車站，或者這是第一次定位結果，才執行切換
                    if (nearestId !== currentStopId) {
                        setStop(nearestId, !silent);
                    } else if (window.innerWidth < 768 && !silent) {
                        // 如果車站沒變，但選單開著，仍需手動關閉
                        toggleStopList(false);
                    }
                    
                    if (isHighRes && navigator.vibrate) navigator.vibrate(50);
                }

                if (isHighRes || isFinal) {
                    btn.classList.remove('animate-spin');
                    btn.disabled = false;
                }
            };

            // 第一階段：快速定位 (低精度, 3秒超時)
            navigator.geolocation.getCurrentPosition(
                (pos) => handleCoords(pos, false),
                null,
                { enableHighAccuracy: false, timeout: 3000 }
            );

            // 第二階段：精確定位 (高精度, 15秒超時)
            navigator.geolocation.getCurrentPosition(
                (pos) => handleCoords(pos, true),
                (err) => {
                    if (!isFinal) { // 如果連低精度都沒拿到才報錯
                        if (!silent) alert(lang === 'zh' ? "定位失敗" : "Location failed");
                        btn.classList.remove('animate-spin');
                        btn.disabled = false;
                    }
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        };

        window.changeMode = (m) => { currentMode = m; expandedTripId = null; renderAll(); saveSettings(); };
        window.toggleTripDetails = (id) => { expandedTripId = (expandedTripId === id) ? null : id; processAndRender(); };

        function formatTime(t) { return t.split(':').slice(0, 2).join(':'); }

        function renderTimeline(bus) {
            if (!db.route_times) return '';
            const steps = db.route_times.filter(t => t.route_id === bus.route_id);
            let baseSec = -1;
            const asToStop = steps.find(s => s.to_stop_id === bus.stop_id);
            if (asToStop) baseSec = asToStop.expected_duration_sec;
            else if (steps.some(s => s.from_stop_id === bus.stop_id)) baseSec = 0;
            if (baseSec === -1) return `<div class="mt-2 py-2 text-[10px] text-slate-400 italic text-center border-t border-slate-100 dark:border-slate-800">${i18n[lang].term}</div>`;
            const nextSteps = steps.filter(s => s.expected_duration_sec > baseSec).sort((a, b) => a.expected_duration_sec - b.expected_duration_sec);
            
            return `
                <div class="mt-2 pt-2 border-t border-slate-100 dark:border-slate-800 space-y-1.5">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest px-1">${i18n[lang].next}</p>
                    <div class="space-y-1 px-1">
                        ${nextSteps.map(step => {
                            const baseDate = getNow();
                            const [h, m, s] = bus.arrival_time.split(':').map(Number);
                            const arrivalDate = new Date(baseDate.setHours(h, m, s || 0, 0));
                            arrivalDate.setSeconds(arrivalDate.getSeconds() + (step.expected_duration_sec - baseSec));
                            const est = arrivalDate.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', hour12: false });
                            const sObj = db.stops.find(x => x.id === step.to_stop_id);
                            return `
                            <div class="flex justify-between items-center group">
                                <div class="flex items-center gap-2">
                                    <div class="w-1 h-1 rounded-full bg-slate-300 dark:bg-slate-600 group-hover:bg-indigo-400 transition-colors"></div>
                                    <span class="text-[11px] font-medium text-slate-600 dark:text-slate-400">${sObj ? (lang === 'zh' ? sObj.name_zh : sObj.name_en) : step.to_stop_id}</span>
                                </div>
                                <span class="text-[10px] font-mono font-bold text-slate-400 group-hover:text-indigo-500">${est}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }

        function processAndRender() {
            const listDiv = document.getElementById('bus-list');
            const now = getNow();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const filtered = db.arrivals.filter(arr => {
                if (arr.stop_id !== currentStopId) return false;
                const dt = arr.day_type || "";
                let isMatch = (currentMode === 'weekday') ? (dt.includes('MON') || dt === 'N' || dt === "") : (dt.includes('SUN') || dt.includes('HOLIDAY') || dt === 'N');
                if (!isMatch) return false;
                // [Fix A] Use helper
                arr.diff = calcDiffMinutes(arr.arrival_time, currentMinutes);
                return arr.diff >= -1 && arr.diff <= 60;
            }).sort((a, b) => a.diff - b.diff);

            // [Fix Ghost Scroll] Removed renderStopGrid() from here.
            // It causes the list to rebuild and reset scroll position.
            // We only update the stop list when searching, changing mode, or fresh data loads.

            if (filtered.length === 0) { listDiv.innerHTML = `<div class="py-12 text-center text-slate-400 text-xs font-medium border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-lg">${i18n[lang].empty}</div>`; return; }

            listDiv.innerHTML = filtered.map(bus => {
                const routeMatch = bus.route_name.match(/^[0-9A-Z]+/i);
                const routeDisp = routeMatch ? routeMatch[0] : bus.route_name.split(' ')[0];
                const tripId = `${bus.route_id}-${bus.stop_id}-${bus.arrival_time}`;
                const isExpanded = expandedTripId === tripId;
                
                let statusCls = 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 border-emerald-100 dark:border-emerald-800/30';
                let timeLabel = i18n[lang].unit, displayDiff = bus.diff;

                if (bus.diff <= 0) { 
                    statusCls = 'text-slate-400 bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'; 
                    timeLabel = i18n[lang].arrived; displayDiff = '--'; 
                } else if (bus.diff <= 5) { 
                    statusCls = 'text-rose-600 bg-rose-50 dark:bg-rose-900/20 border-rose-100 dark:border-rose-800/30 font-bold'; 
                    timeLabel = i18n[lang].soon;
                }

                return `
                <!-- [Fix] Outer card handles expand toggle globally -->
                <div onclick="toggleTripDetails('${tripId}')" class="apple-card rounded-[24px] px-5 py-5 cursor-pointer active:scale-[0.98] ${isExpanded ? 'ring-2 ring-apple-accent/20 border-apple-accent/30' : ''}">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <!-- [Fix] Logo has stopPropagation to prevent triggering outer card -->
                            <div onclick="openRouteDetails('${bus.route_id}', event)" class="w-12 h-12 shrink-0 bg-black dark:bg-white rounded-[14px] flex items-center justify-center text-white dark:text-black font-black text-sm shadow-apple hover:scale-110 active:scale-90 transition-transform z-10 relative group">
                                ${routeDisp}
                                <!-- Optional: Tiny indicator to hint clickability -->
                                <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-blue-500 rounded-full text-white flex items-center justify-center border-2 border-white dark:border-black opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg class="w-2 h-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                            </div>
                            
                            <div class="flex flex-col">
                                <span class="text-[19px] font-extrabold tracking-tight text-slate-900 dark:text-white leading-none">${formatTime(bus.arrival_time)}</span>
                                <!-- Route name removed for cleaner Apple-style UI -->
                            </div>
                        </div>
                        <div class="px-4 py-2 rounded-[16px] ${statusCls.replace('border-indigo-100', 'border-transparent')} text-center min-w-[70px]">
                            <div class="text-lg font-black leading-none">${displayDiff}</div>
                            <div class="text-[9px] font-bold uppercase mt-1 opacity-70">${timeLabel}</div>
                        </div>
                    </div>
                    ${isExpanded ? `<div class="mt-4 px-1 animate-in fade-in slide-in-from-top-2 duration-300">${renderTimeline(bus)}</div>` : ''}
                </div>`;
            }).join('');
        }

        function updateClock() {
            const now = getNow();
            
            // [Fix] Midnight auto-refresh logic
            const currentDay = now.getDay();
            if (currentDay !== lastCheckedDay) {
                lastCheckedDay = currentDay;
                const newMode = (currentDay === 0) ? 'sunday' : 'weekday';
                if (currentMode !== newMode) {
                    currentMode = newMode;
                    // Force full rebuild to update stop badges and mode selector
                    renderAll(true);
                    saveSettings();
                }
            }

            const timeStr = now.toLocaleTimeString('zh-HK', { hour12: false });
            document.getElementById('current-time').innerHTML = mockTime ? `<span class="text-rose-500 font-bold">MOCK: ${timeStr}</span>` : timeStr;
        }

        // [Feature] Route Details Modal Logic
        window.openRouteDetails = (routeId, event) => {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            
            const route = db.routes.find(r => r.id === routeId);
            if (!route) return;

            if (navigator.vibrate) navigator.vibrate(8);

            const modal = document.getElementById('route-modal');
            
            // 同步卡片邏輯：提取短路由名稱 (例如 "1A")
            const routeMatch = routeId.match(/^[0-9A-Z]+/i);
            const routeDisp = routeMatch ? routeMatch[0] : routeId.split(' ')[0];

            // Populate Data
            document.getElementById('modal-route-icon').innerText = routeDisp;
            document.getElementById('modal-route-name').innerText = lang === 'zh' ? route.name_zh : route.name_en;
            document.getElementById('modal-route-category').innerText = lang === 'zh' ? route.category_zh : route.category_en;
            document.getElementById('modal-route-time').innerText = route.open_close_time_UI || '--';
            document.getElementById('modal-route-freq').innerText = route.departure_time_UI || '--';
            document.getElementById('modal-route-days').innerText = route.open_weekdays_UI || '--';
            
            const remarks = lang === 'zh' ? route.remarks_zh : route.remarks_en;
            const remarksContainer = document.getElementById('modal-remarks-container');
            if (remarks) {
                document.getElementById('modal-remarks').innerText = remarks;
                remarksContainer.classList.remove('hidden');
            } else {
                remarksContainer.classList.add('hidden');
            }

            // Show Animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('visible');
                document.body.classList.add('modal-open');
            }, 10);
        };

        window.closeRouteModal = () => {
            const modal = document.getElementById('route-modal');
            // 1. 移除 visible class，這會觸發 CSS 中的 transform 向上/向右滑出動畫
            modal.classList.remove('visible');
            document.body.classList.remove('modal-open');
            
            // 2. 等待動畫結束 (500ms) 再隱藏容器
            setTimeout(() => {
                // 再次檢查以免在延遲期間用戶又點開了
                if (!modal.classList.contains('visible')) {
                    modal.classList.add('hidden');
                }
            }, 500);
        };

        function initBottomSheet(sheetId, handleId, closeFn) {
            const sheet = document.getElementById(sheetId);
            const scrollContent = sheet.querySelector('.overflow-y-auto');
            if (!sheet || window.innerWidth >= 768) return;

            let startY = 0;
            let currentTranslateY = 0;
            let isDragging = false;

            const onTouchStart = (e) => {
                if (window.innerWidth >= 768) return;
                startY = e.touches[0].clientY;
            };

            const onTouchMove = (e) => {
                if (window.innerWidth >= 768) return;
                
                const touchY = e.touches[0].clientY;
                const isAtTop = scrollContent ? scrollContent.scrollTop <= 0 : true;
                let deltaY = touchY - startY;

                // 核心邏輯：判斷是否該從「捲動內容」轉向「拖拽面板」
                if (isAtTop && deltaY > 0) {
                    // 如果是剛觸發拖拽，重新設定 startY，防止跳動
                    if (!isDragging) {
                        isDragging = true;
                        startY = touchY; // 重置起點
                        deltaY = 0;
                        sheet.classList.add('dragging');
                    }

                    // 阻止原生捲動行為
                    if (e.cancelable) e.preventDefault();
                    
                    // 下拉位移
                    currentTranslateY = deltaY;
                    sheet.style.transform = `translateY(${currentTranslateY}px)`;
                } else if (isDragging && deltaY <= 0) {
                    // 如果正在拖拽但轉向往上推，且還沒推回原位
                    if (currentTranslateY > 0) {
                        if (e.cancelable) e.preventDefault();
                        currentTranslateY = Math.max(0, deltaY + currentTranslateY);
                        sheet.style.transform = `translateY(${currentTranslateY}px)`;
                    } else {
                        // 回到原位，恢復正常捲動
                        isDragging = false;
                        sheet.classList.remove('dragging');
                        sheet.style.transform = '';
                    }
                }
            };

            const onTouchEnd = (e) => {
                if (!isDragging) return;
                
                const touchY = e.changedTouches[0].clientY;
                const deltaY = touchY - startY;
                
                isDragging = false;
                sheet.classList.remove('dragging');
                sheet.style.transform = ''; // 交給 CSS transition 處理

                // 門檻值：下滑超過 100px 則關閉
                if (deltaY > 100) {
                    closeFn();
                }
            };

            // 監聽整個 Sheet 的觸控，但邏輯內部判斷是否要接管
            sheet.addEventListener('touchstart', onTouchStart, { passive: true });
            sheet.addEventListener('touchmove', onTouchMove, { passive: false });
            sheet.addEventListener('touchend', onTouchEnd);
        }

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeRouteModal();
        });
    </script>
</body>
</html>