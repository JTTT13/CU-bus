<!DOCTYPE html>
<html lang="zh-HK" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BusVibe Pro | Enterprise Transit Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'Inter', 'system-ui'], mono: ['JetBrains Mono'] },
                    boxShadow: {
                        'apple': '0 8px 30px rgb(0,0,0,0.04)',
                        'apple-dark': '0 8px 30px rgb(0,0,0,0.2)'
                    },
                    colors: {
                        apple: { gray: '#F5F5F7', dark: '#1D1D1F', accent: '#007AFF' }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-feature-settings: "cv02", "cv03", "cv04", "cv11"; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); }
        .dark .glass { background: rgba(29, 29, 31, 0.75); }
        .apple-card { @apply bg-white/70 dark:bg-apple-dark/60 border border-white/20 dark:border-white/5 shadow-apple transition-all duration-300 ease-in-out; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
        
        .sticky-panel { position: sticky; top: 80px; z-index: 40; }
        @media (max-width: 767px) {
            .sticky-panel { margin: 0; padding: 1rem 0; border-bottom: none; background: transparent; }
        }

        .bus-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.5rem; }
        @media (max-width: 640px) { .bus-card-grid { grid-template-columns: 1fr; gap: 1rem; } }
    </style>
</head>
<body class="bg-apple-gray dark:bg-[#000000] text-slate-900 dark:text-slate-100 min-h-screen font-sans antialiased tracking-tight">

    <!-- Navbar: Apple Style Glass Floating Bar -->
    <nav class="sticky top-0 z-50 glass border-b border-black/[0.05] dark:border-white/[0.05] h-16">
        <div class="max-w-7xl mx-auto px-6 h-full flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 bg-black dark:bg-white rounded-[10px] flex items-center justify-center text-white dark:text-black font-extrabold text-sm shadow-apple">B</div>
                <div class="flex flex-col">
                    <span class="text-[15px] font-semibold tracking-tight leading-tight">BusVibe <span class="opacity-50 font-medium">Pro</span></span>
                    <span id="current-time" class="text-[11px] font-medium text-slate-400 leading-none mt-0.5">00:00:00</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleDarkMode()" class="p-2 hover:bg-black/[0.05] dark:hover:bg-white/[0.1] rounded-full transition-all">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"></svg>
                </button>
                <button onclick="toggleLang()" id="lang-btn" class="text-[11px] font-bold px-3 py-1.5 bg-black/[0.05] dark:bg-white/[0.1] rounded-full hover:bg-black/[0.1] dark:hover:bg-white/[0.2] transition-all">EN</button>
                <button onclick="loadData()" id="refresh-btn" class="p-2 bg-black dark:bg-white text-white dark:text-black rounded-full transition-all active:scale-90 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-3 md:py-6">
        <div class="flex flex-col md:flex-row gap-4 lg:gap-6">
            
            <!-- Sidebar: Clean Apple Layout -->
            <aside class="w-full md:w-80 shrink-0">
                <div class="sticky-panel space-y-6">
                    <!-- Segmented Control (iOS Style) -->
                    <div id="mode-selector" class="flex p-1 bg-black/[0.05] dark:bg-white/[0.1] rounded-[12px] backdrop-blur-md"></div>

                    <!-- Stop Selector Card -->
                    <div class="apple-card rounded-[24px] overflow-hidden">
                        <button onclick="toggleStopList()" class="w-full py-4 px-5 flex items-center justify-between md:hidden transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full bg-apple-accent shadow-[0_0_8px_rgba(0,122,255,0.5)]"></div>
                                <span id="mobile-current-stop" class="font-semibold text-sm text-slate-900 dark:text-white">Select Stop</span>
                            </div>
                            <svg id="stop-chevron" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" /></svg>
                        </button>

                        <div id="stop-list-container" class="hidden md:block">
                            <div class="p-4 border-b border-black/[0.03] dark:border-white/[0.03] flex gap-2">
                                <input type="text" id="stop-search" oninput="renderStopGrid()" placeholder="Search..." class="flex-1 bg-black/[0.03] dark:bg-white/[0.05] text-[13px] px-4 py-2 rounded-[12px] outline-none focus:ring-2 ring-apple-accent/20 transition-all">
                                <button id="gps-btn" onclick="findNearestStop()" class="p-2 bg-apple-accent text-white rounded-[12px] hover:opacity-90 active:scale-90 transition-all shadow-md flex items-center justify-center disabled:opacity-30" title="Find nearest stop">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                            </div>
                            <div id="stop-grid" class="max-h-[300px] md:max-h-[60vh] overflow-y-auto custom-scrollbar p-2 space-y-1"></div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <section class="flex-1 space-y-3">
                <div class="flex items-center justify-between px-1">
                    <div class="flex items-center gap-2">
                        <h2 id="arrival-title" class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">Arrivals</h2>
                        <span id="selected-stop-name" class="hidden md:inline-block text-[10px] font-semibold text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded border border-indigo-100 dark:border-indigo-800">---</span>
                    </div>
                </div>
                <div id="bus-list" class="bus-card-grid"></div>
            </section>
        </div>
    </main>

    <script>
        const DATA_URL = 'bus_data.json';
        const SETTINGS_KEY = 'cuhk_bus_vibe_settings';
        let db = { stops: [], arrivals: [], route_times: [] };

        const urlParams = new URLSearchParams(window.location.search);
        let mockTime = urlParams.get('time');

        let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {
            stopId: '', lang: 'zh', isDark: window.matchMedia('(prefers-color-scheme: dark)').matches, mode: (new Date().getDay() === 0) ? 'sunday' : 'weekday'
        };

        let { stopId: currentStopId, lang, isDark, mode: currentMode } = settings;
        let isStopListOpen = false, expandedTripId = null;

        const i18n = {
            zh: { weekday: '平日/教學日', sunday: '假日/週日', arrival: '實時到站', empty: '當前時段無班次', arrived: '已抵達', soon: '即將', unit: '分', search: '搜尋車站...', next: '後續車站 (預計)', term: '終點站' },
            en: { weekday: 'Weekday', sunday: 'Weekend/Holiday', arrival: 'Real-time Arrivals', empty: 'No service at this time', arrived: 'Arrived', soon: 'Soon', unit: 'min', search: 'Search stops...', next: 'Trip Timeline', term: 'Terminus' }
        };

        window.onload = () => {
            document.documentElement.classList.toggle('dark', isDark);
            updateThemeIcon();
            document.getElementById('lang-btn').innerText = (lang === 'zh') ? 'EN' : '中文';
            updateClock(); setInterval(updateClock, 1000); loadData(); setInterval(loadData, 30000);
        };

        function getNow() {
            if (!mockTime) return new Date();
            const [h, m] = mockTime.split(':');
            const d = new Date(); d.setHours(parseInt(h), parseInt(m), 0); return d;
        }

        function saveSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify({ stopId: currentStopId, lang, isDark, mode: currentMode }));
        }

        function toggleDarkMode() { isDark = !isDark; document.documentElement.classList.toggle('dark', isDark); updateThemeIcon(); saveSettings(); }
        function updateThemeIcon() {
            document.getElementById('theme-icon').innerHTML = isDark ? '<path stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 9h-1m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" />' : '<path stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
        }

        function toggleLang() { lang = (lang === 'zh') ? 'en' : 'zh'; document.getElementById('lang-btn').innerText = (lang === 'zh') ? 'EN' : '中文'; document.getElementById('stop-search').placeholder = i18n[lang].search; renderAll(); saveSettings(); }

        function loadData() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('animate-spin');
            if (db.stops.length === 0) document.getElementById('bus-list').innerHTML = Array(4).fill(0).map(() => `<div class="h-14 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800 animate-pulse"></div>`).join('');
            
            fetch(DATA_URL + '?t=' + Date.now()).then(res => res.json()).then(data => {
                db = data; btn.classList.remove('animate-spin');
                if (!db.stops.some(s => s.id === currentStopId) && db.stops.length > 0) currentStopId = db.stops[0].id;
                renderAll();
            }).catch(() => btn.classList.remove('animate-spin'));
        }

        function renderAll() { renderModeSelector(); renderStopGrid(); processAndRender(); updateStopLabels(); }

        function updateStopLabels() {
            const stop = db.stops.find(s => s.id === currentStopId);
            const name = stop ? (lang === 'zh' ? stop.name_zh : stop.name_en) : '---';
            document.getElementById('mobile-current-stop').innerText = name;
            document.getElementById('selected-stop-name').innerText = name;
            document.getElementById('arrival-title').innerText = i18n[lang].arrival;
        }

        function renderModeSelector() {
            const modes = ['weekday', 'sunday'];
            document.getElementById('mode-selector').innerHTML = modes.map(m => `
                <button onclick="changeMode('${m}')" class="flex-1 py-1.5 text-[12px] font-semibold rounded-[9px] transition-all duration-300 ${currentMode === m ? 'bg-white dark:bg-[#3A3A3C] text-black dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-900 dark:hover:text-slate-300'}">
                    ${i18n[lang][m]}
                </button>
            `).join('');
        }

        function renderStopGrid() {
            const query = document.getElementById('stop-search').value.toLowerCase();
            const container = document.getElementById('stop-grid');
            const now = getNow();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            // 1. 預先計算每個站點的班次數量 (未來60分鐘)
            const busCounts = {};
            db.arrivals.forEach(arr => {
                const dt = arr.day_type || "";
                const isMatch = (currentMode === 'weekday') ? (dt.includes('MON') || dt === 'N' || dt === "") : (dt.includes('SUN') || dt.includes('HOLIDAY') || dt === 'N');
                if (!isMatch) return;

                const p = arr.arrival_time.split(':').map(Number);
                const totalMin = p[0] * 60 + p[1];
                const diff = totalMin - currentMinutes;

                if (diff >= -1 && diff <= 60) {
                    busCounts[arr.stop_id] = (busCounts[arr.stop_id] || 0) + 1;
                }
            });

            // 2. 渲染列表
            container.innerHTML = db.stops.filter(s => s.name_zh.toLowerCase().includes(query) || s.name_en.toLowerCase().includes(query)).map(stop => {
                const count = busCounts[stop.id] || 0;
                const isSelected = currentStopId === stop.id;
                
                // Apple Style Badge 樣式
                let badgeClass = count > 0
                    ? (isSelected ? 'bg-white/30 text-white' : 'bg-apple-accent/10 text-apple-accent dark:bg-apple-accent/20')
                    : 'opacity-20 grayscale';

                return `
                <button onclick="setStop('${stop.id}')" class="w-full px-4 py-2.5 rounded-[12px] text-[13px] font-medium text-left transition-all flex items-center justify-between group ${isSelected ? 'bg-apple-accent text-white shadow-md' : 'text-slate-600 dark:text-slate-400 hover:bg-black/[0.03] dark:hover:bg-white/[0.05]'}">
                    <span class="truncate pr-2">${lang === 'zh' ? stop.name_zh : stop.name_en}</span>
                    <span class="shrink-0 font-mono text-[10px] px-2 py-0.5 rounded-full transition-colors ${badgeClass}">
                        ${count}
                    </span>
                </button>
                `;
            }).join('');
        }

        window.toggleStopList = () => {
            isStopListOpen = !isStopListOpen;
            document.getElementById('stop-list-container').classList.toggle('hidden', !isStopListOpen);
            document.getElementById('stop-chevron').classList.toggle('rotate-180', isStopListOpen);
        };

        window.setStop = (id) => { currentStopId = id; if (window.innerWidth < 768) toggleStopList(); expandedTripId = null; renderAll(); saveSettings(); };

        window.findNearestStop = () => {
            if (db.stops.length === 0) return; // 數據未載入
            
            if (!navigator.geolocation) {
                alert(lang === 'zh' ? "您的瀏覽器不支援定位" : "Geolocation not supported");
                return;
            }

            const btn = document.getElementById('gps-btn');
            btn.classList.add('animate-spin');
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition((position) => {
                const { latitude, longitude } = position.coords;
                let minDistance = Infinity;
                let nearestId = null;

                db.stops.forEach(stop => {
                    // 確保 stop.long 存在 (對應你提供的資料格式)
                    const stopLong = stop.long || stop.lng;
                    if (stop.lat && stopLong) {
                        // 使用勾股定理計算距離
                        const d = Math.sqrt(Math.pow(stop.lat - latitude, 2) + Math.pow(stopLong - longitude, 2));
                        if (d < minDistance) {
                            minDistance = d;
                            nearestId = stop.id;
                        }
                    }
                });

                if (nearestId) {
                    setStop(nearestId);
                    if (navigator.vibrate) navigator.vibrate(50);
                }
                
                btn.classList.remove('animate-spin');
                btn.disabled = false;
            }, (err) => {
                let msg = lang === 'zh' ? "定位失敗：請確保已開啟 GPS 並允許權限" : "Location failed: Please enable GPS and permissions";
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    msg += " (Insecure Context: HTTPS required)";
                }
                alert(msg);
                btn.classList.remove('animate-spin');
                btn.disabled = false;
            }, { enableHighAccuracy: true, timeout: 10000 });
        };

        window.changeMode = (m) => { currentMode = m; expandedTripId = null; renderAll(); saveSettings(); };
        window.toggleTripDetails = (id) => { expandedTripId = (expandedTripId === id) ? null : id; processAndRender(); };

        function formatTime(t) { return t.split(':').slice(0, 2).join(':'); }

        function renderTimeline(bus) {
            if (!db.route_times) return '';
            const steps = db.route_times.filter(t => t.route_id === bus.route_id);
            let baseSec = -1;
            const asToStop = steps.find(s => s.to_stop_id === bus.stop_id);
            if (asToStop) baseSec = asToStop.expected_duration_sec;
            else if (steps.some(s => s.from_stop_id === bus.stop_id)) baseSec = 0;
            if (baseSec === -1) return `<div class="mt-2 py-2 text-[10px] text-slate-400 italic text-center border-t border-slate-100 dark:border-slate-800">${i18n[lang].term}</div>`;
            const nextSteps = steps.filter(s => s.expected_duration_sec > baseSec).sort((a, b) => a.expected_duration_sec - b.expected_duration_sec);
            
            return `
                <div class="mt-2 pt-2 border-t border-slate-100 dark:border-slate-800 space-y-1.5">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest px-1">${i18n[lang].next}</p>
                    <div class="space-y-1 px-1">
                        ${nextSteps.map(step => {
                            const baseDate = getNow();
                            const [h, m, s] = bus.arrival_time.split(':').map(Number);
                            const arrivalDate = new Date(baseDate.setHours(h, m, s || 0, 0));
                            arrivalDate.setSeconds(arrivalDate.getSeconds() + (step.expected_duration_sec - baseSec));
                            const est = arrivalDate.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', hour12: false });
                            const sObj = db.stops.find(x => x.id === step.to_stop_id);
                            return `
                            <div class="flex justify-between items-center group">
                                <div class="flex items-center gap-2">
                                    <div class="w-1 h-1 rounded-full bg-slate-300 dark:bg-slate-600 group-hover:bg-indigo-400 transition-colors"></div>
                                    <span class="text-[11px] font-medium text-slate-600 dark:text-slate-400">${sObj ? (lang === 'zh' ? sObj.name_zh : sObj.name_en) : step.to_stop_id}</span>
                                </div>
                                <span class="text-[10px] font-mono font-bold text-slate-400 group-hover:text-indigo-500">${est}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }

        function processAndRender() {
            const listDiv = document.getElementById('bus-list');
            const now = getNow();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const filtered = db.arrivals.filter(arr => {
                if (arr.stop_id !== currentStopId) return false;
                const dt = arr.day_type || "";
                let isMatch = (currentMode === 'weekday') ? (dt.includes('MON') || dt === 'N' || dt === "") : (dt.includes('SUN') || dt.includes('HOLIDAY') || dt === 'N');
                if (!isMatch) return false;
                const p = arr.arrival_time.split(':').map(Number);
                let totalMin = p[0] * 60 + p[1];
                arr.diff = totalMin - currentMinutes;
                return arr.diff >= -1 && arr.diff <= 60;
            }).sort((a, b) => a.diff - b.diff);

            // 每當班次列表更新時，同步更新側邊欄的計數標籤
            renderStopGrid();

            if (filtered.length === 0) { listDiv.innerHTML = `<div class="py-12 text-center text-slate-400 text-xs font-medium border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-lg">${i18n[lang].empty}</div>`; return; }

            listDiv.innerHTML = filtered.map(bus => {
                const routeMatch = bus.route_name.match(/^[0-9A-Z]+/i);
                const routeDisp = routeMatch ? routeMatch[0] : bus.route_name.split(' ')[0];
                const tripId = `${bus.route_id}-${bus.stop_id}-${bus.arrival_time}`;
                const isExpanded = expandedTripId === tripId;
                
                let statusCls = 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 border-emerald-100 dark:border-emerald-800/30';
                let timeLabel = i18n[lang].unit, displayDiff = bus.diff;

                if (bus.diff <= 0) { 
                    statusCls = 'text-slate-400 bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'; 
                    timeLabel = i18n[lang].arrived; displayDiff = '--'; 
                } else if (bus.diff <= 5) { 
                    statusCls = 'text-rose-600 bg-rose-50 dark:bg-rose-900/20 border-rose-100 dark:border-rose-800/30 font-bold'; 
                    timeLabel = i18n[lang].soon;
                }

                return `
                <div onclick="toggleTripDetails('${tripId}')" class="apple-card rounded-[24px] px-5 py-4 cursor-pointer active:scale-[0.98] ${isExpanded ? 'ring-2 ring-apple-accent/20 border-apple-accent/30' : ''}">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 shrink-0 bg-black dark:bg-white rounded-[14px] flex items-center justify-center text-white dark:text-black font-black text-sm shadow-apple">${routeDisp}</div>
                            <div class="flex flex-col">
                                <span class="text-lg font-bold tracking-tighter text-slate-900 dark:text-white leading-none">${formatTime(bus.arrival_time)}</span>
                                <span class="text-[11px] font-medium text-slate-400 mt-1.5 uppercase tracking-wide opacity-80">${bus.route_name}</span>
                            </div>
                        </div>
                        <div class="px-4 py-2 rounded-[16px] ${statusCls.replace('border-indigo-100', 'border-transparent')} text-center min-w-[70px]">
                            <div class="text-lg font-black leading-none">${displayDiff}</div>
                            <div class="text-[9px] font-bold uppercase mt-1 opacity-70">${timeLabel}</div>
                        </div>
                    </div>
                    ${isExpanded ? `<div class="mt-4 px-1 animate-in fade-in slide-in-from-top-2 duration-300">${renderTimeline(bus)}</div>` : ''}
                </div>`;
            }).join('');
        }

        function updateClock() { 
            const now = getNow();
            const timeStr = now.toLocaleTimeString('zh-HK', { hour12: false });
            document.getElementById('current-time').innerHTML = mockTime ? `<span class="text-rose-500 font-bold">MOCK: ${timeStr}</span>` : timeStr;
        }
    </script>
</body>
</html>